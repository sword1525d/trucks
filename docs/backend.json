
{
  "entities": {
    "Company": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Company",
      "type": "object",
      "description": "Represents a company that uses the Frotacontrol system.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Company entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the company."
        }
      },
      "required": [
        "id",
        "name"
      ]
    },
    "Sector": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Sector",
      "type": "object",
      "description": "Represents a sector within a company.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Sector entity."
        },
        "companyId": {
          "type": "string",
          "description": "Reference to Company. (Relationship: Company 1:N Sector)"
        },
        "name": {
          "type": "string",
          "description": "The name of the sector."
        }
      },
      "required": [
        "id",
        "companyId",
        "name"
      ]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user within the Frotacontrol system.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the User entity (matricula)."
        },
        "companyId": {
          "type": "string",
          "description": "Reference to Company. (Relationship: Company 1:N User)"
        },
        "sectorId": {
          "type": "string",
          "description": "Reference to Sector. (Relationship: Sector 1_N User)"
        },
        "name": {
          "type": "string",
          "description": "The user's full name."
        },
        "password": {
          "type": "string",
          "description": "The user's password. This should be handled securely."
        },
        "truck": {
          "type": "boolean",
          "description": "Indicates if the user is a truck driver."
        },
        "isAdmin": {
          "type": "boolean",
          "description": "Indicates if the user has administrative privileges."
        },
        "shift": {
          "type": "string",
          "description": "The user's work shift.",
          "enum": [
            "1째 NORMAL",
            "2째 NORMAL",
            "1째 ESPECIAL",
            "2째 ESPECIAL"
          ]
        }
      },
      "required": [
        "id",
        "companyId",
        "sectorId",
        "name",
        "password"
      ]
    },
    "Vehicle": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Vehicle",
      "type": "object",
      "description": "Represents a vehicle within a company's sector.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Vehicle entity (e.g., license plate)."
        },
        "companyId": {
          "type": "string",
          "description": "Reference to Company. (Relationship: Company 1:N Vehicle)"
        },
        "sectorId": {
          "type": "string",
          "description": "Reference to Sector. (Relationship: Sector 1:N Vehicle)"
        },
        "model": {
          "type": "string",
          "description": "The model of the vehicle."
        },
        "imageUrl": {
          "type": "string",
          "format": "uri",
          "description": "A URL pointing to an image of the vehicle."
        },
        "isTruck": {
          "type": "boolean",
          "description": "Indicates if the vehicle is a truck."
        },
        "status": {
          "type": "string",
          "enum": [
            "PARADO",
            "EM_CORRIDA",
            "EM_MANUTENCAO"
          ],
          "description": "The current status of the vehicle."
        }
      },
      "required": [
        "id",
        "companyId",
        "sectorId",
        "model"
      ]
    },
    "Run": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Run",
      "type": "object",
      "description": "Represents a truck run or trip.",
      "properties": {
        "driverId": {
          "type": "string"
        },
        "driverName": {
          "type": "string"
        },
        "vehicleId": {
          "type": "string"
        },
        "startMileage": {
          "type": "number"
        },
        "endMileage": {
          "type": "number"
        },
        "startTime": {
          "type": "string",
          "format": "date-time"
        },
        "endTime": {
          "type": "string",
          "format": "date-time"
        },
        "status": {
          "type": "string",
          "enum": [
            "IN_PROGRESS",
            "COMPLETED"
          ]
        },
        "stops": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": {
                "type": "string"
              },
              "status": {
                "type": "string",
                "enum": [
                  "PENDING",
                  "IN_PROGRESS",
                  "COMPLETED",
                  "CANCELED"
                ]
              },
              "arrivalTime": {
                "type": "string",
                "format": "date-time"
              },
              "departureTime": {
                "type": "string",
                "format": "date-time"
              },
              "collectedOccupiedCars": {
                "type": "number"
              },
              "collectedEmptyCars": {
                "type": "number"
              },
              "mileageAtStop": {
                "type": [
                  "number",
                  "null"
                ]
              },
              "occupancy": {
                "type": "number",
                "description": "The occupancy rate of the truck at this stop, from 0 to 100."
              }
            },
            "required": [
              "name",
              "status"
            ]
          }
        },
        "locationHistory": {
          "type": "array",
          "description": "Stores the history of GPS locations for the run.",
          "items": {
            "type": "object",
            "properties": {
              "latitude": {
                "type": "number"
              },
              "longitude": {
                "type": "number"
              },
              "timestamp": {
                "type": "string",
                "format": "date-time"
              }
            },
            "required": [
              "latitude",
              "longitude",
              "timestamp"
            ]
          }
        }
      },
      "required": [
        "driverId",
        "driverName",
        "vehicleId",
        "startMileage",
        "startTime",
        "status",
        "stops"
      ]
    },
    "MaintenanceRecord": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Maintenance Record",
      "type": "object",
      "description": "Represents a maintenance record for a vehicle.",
      "properties": {
        "startTime": {
          "type": "string",
          "format": "date-time",
          "description": "The timestamp when the maintenance started."
        },
        "endTime": {
          "type": "string",
          "format": "date-time",
          "description": "The timestamp when the maintenance ended."
        },
        "notes": {
          "type": "string",
          "description": "Optional notes about the maintenance."
        }
      },
      "required": ["startTime"]
    },
    "RefuelRecord": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Refuel Record",
      "type": "object",
      "description": "Represents a fuel refill record for a vehicle.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the refuel record."
        },
        "vehicleId": {
          "type": "string",
          "description": "The ID of the vehicle that was refueled."
        },
        "driverId": {
          "type": "string",
          "description": "The ID of the driver who registered the refill."
        },
        "driverName": {
          "type": "string",
          "description": "The name of the driver."
        },
        "liters": {
          "type": "number",
          "description": "The amount of fuel in liters."
        },
        "amount": {
          "type": "number",
          "description": "The total cost of the refill."
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "The timestamp of when the refill was registered."
        }
      },
      "required": [
        "id",
        "vehicleId",
        "driverId",
        "driverName",
        "liters",
        "amount",
        "timestamp"
      ]
    },
    "Checklist": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Checklist",
      "type": "object",
      "description": "Represents a daily vehicle checklist.",
      "properties": {
        "vehicleId": {
          "type": "string",
          "description": "The ID of the vehicle being checked."
        },
        "driverId": {
          "type": "string",
          "description": "The ID of the driver performing the check."
        },
        "driverName": {
          "type": "string",
          "description": "The name of the driver."
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "The timestamp of when the checklist was completed."
        },
        "items": {
          "type": "array",
          "description": "The list of checked items and their status.",
          "items": {
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "location": { "type": "string" },
              "title": { "type": "string" },
              "description": { "type": "string" },
              "status": {
                "type": "string",
                "enum": ["conforme", "nao_conforme", "na"]
              }
            },
            "required": ["id", "title", "status"]
          }
        }
      },
      "required": ["vehicleId", "driverId", "driverName", "timestamp", "items"]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/companies/{companyId}",
        "definition": {
          "entityName": "Company",
          "schema": {
            "$ref": "#/backend/entities/Company"
          },
          "description": "Stores company information."
        }
      },
      {
        "path": "/companies/{companyId}/sectors/{sectorId}",
        "definition": {
          "entityName": "Sector",
          "schema": {
            "$ref": "#/backend/entities/Sector"
          },
          "description": "Stores sector information within a company."
        }
      },
      {
        "path": "/companies/{companyId}/sectors/{sectorId}/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user information within a company and sector."
        }
      },
      {
        "path": "/companies/{companyId}/sectors/{sectorId}/vehicles/{vehicleId}",
        "definition": {
          "entityName": "Vehicle",
          "schema": {
            "$ref": "#/backend/entities/Vehicle"
          },
          "description": "Stores vehicle information within a company and sector."
        }
      },
      {
        "path": "/companies/{companyId}/sectors/{sectorId}/runs/{runId}",
        "definition": {
          "entityName": "Run",
          "schema": {
            "$ref": "#/backend/entities/Run"
          },
          "description": "Stores truck run data within a company and sector."
        }
      },
      {
        "path": "/companies/{companyId}/sectors/{sectorId}/vehicles/{vehicleId}/maintenance/{maintenanceId}",
        "definition": {
          "entityName": "MaintenanceRecord",
          "schema": {
            "$ref": "#/backend/entities/MaintenanceRecord"
          },
          "description": "Stores the maintenance history for a specific vehicle."
        }
      },
       {
        "path": "/companies/{companyId}/sectors/{sectorId}/refuels/{refuelId}",
        "definition": {
          "entityName": "RefuelRecord",
          "schema": {
            "$ref": "#/backend/entities/RefuelRecord"
          },
          "description": "Stores vehicle refuel records within a company and sector."
        }
      },
      {
        "path": "/companies/{companyId}/sectors/{sectorId}/vehicles/{vehicleId}/checklists/{checklistId}",
        "definition": {
          "entityName": "Checklist",
          "schema": {
            "$ref": "#/backend/entities/Checklist"
          },
          "description": "Stores daily checklists for a specific vehicle."
        }
      }
    ],
    "reasoning": "This Firestore structure prioritizes authorization independence and efficient data retrieval for the Frotacontrol application. It leverages path-based ownership for user data within companies and sectors, eliminating the need for `get()` calls in security rules. The structure enforces homogeneous security postures within collections and subcollections.\n\n*   `/companies/{companyId}`: Stores company information.\n*   `/companies/{companyId}/sectors/{sectorId}`: Stores sector information within each company.\n*   `/companies/{companyId}/sectors/{sectorId}/users/{userId}`: Stores user information, keyed by their unique identifier (`matricula`). This structure allows for direct access to user data based on company, sector, and ID, crucial for authentication and authorization. This design uses the appropriate Hierarchical Paths for User-Owned Data.\n*  `/companies/{companyId}/sectors/{sectorId}/vehicles/{vehicleId}/maintenance/{maintenanceId}`: Stores a history of maintenance records for each vehicle, allowing for easy retrieval of a vehicle's maintenance history.\n\nThis design facilitates simple, robust security rules:\n\n*   Rules can directly verify `request.auth.uid` against the `userId` path segment, ensuring that users can only access their own data within a specific company and sector.\n*   `list` operations are secured because each subcollection contains only documents with the same security requirements (users belonging to a specific sector within a specific company).\n\nDenormalization Strategy:\n\nThe vehicle `status` field is denormalized on the vehicle document for efficient querying of vehicle availability without needing to inspect sub-collections. The canonical state for maintenance is the `maintenance` subcollection, which serves as a ledger."
  }
}
