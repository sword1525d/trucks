{
  "entities": {
    "Company": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Company",
      "type": "object",
      "description": "Represents a company that uses the Frotacontrol system.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Company entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the company."
        }
      },
      "required": [
        "id",
        "name"
      ]
    },
    "Sector": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Sector",
      "type": "object",
      "description": "Represents a sector within a company.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Sector entity."
        },
        "companyId": {
          "type": "string",
          "description": "Reference to Company. (Relationship: Company 1:N Sector)"
        },
        "name": {
          "type": "string",
          "description": "The name of the sector."
        }
      },
      "required": [
        "id",
        "companyId",
        "name"
      ]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user within the Frotacontrol system.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the User entity (matricula)."
        },
        "companyId": {
          "type": "string",
          "description": "Reference to Company. (Relationship: Company 1:N User)"
        },
        "sectorId": {
          "type": "string",
          "description": "Reference to Sector. (Relationship: Sector 1_N User)"
        },
        "name": {
          "type": "string",
          "description": "The user's full name."
        },
        "password": {
          "type": "string",
          "description": "The user's password. This should be handled securely."
        },
        "truck": {
          "type": "boolean",
          "description": "Indicates if the user is a truck driver."
        },
        "isAdmin": {
          "type": "boolean",
          "description": "Indicates if the user has administrative privileges."
        }
      },
      "required": [
        "id",
        "companyId",
        "sectorId",
        "name",
        "password"
      ]
    },
    "Vehicle": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Vehicle",
      "type": "object",
      "description": "Represents a vehicle within a company's sector.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Vehicle entity (e.g., license plate)."
        },
        "companyId": {
          "type": "string",
          "description": "Reference to Company. (Relationship: Company 1:N Vehicle)"
        },
        "sectorId": {
          "type": "string",
          "description": "Reference to Sector. (Relationship: Sector 1:N Vehicle)"
        },
        "model": {
          "type": "string",
          "description": "The model of the vehicle."
        },
        "imageUrl": {
          "type": "string",
          "format": "uri",
          "description": "A URL pointing to an image of the vehicle."
        },
        "isTruck": {
          "type": "boolean",
          "description": "Indicates if the vehicle is a truck."
        }
      },
      "required": [
        "id",
        "companyId",
        "sectorId",
        "model"
      ]
    },
    "Run": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Run",
      "type": "object",
      "description": "Represents a truck run or trip.",
      "properties": {
        "driverId": { "type": "string" },
        "driverName": { "type": "string" },
        "vehicleId": { "type": "string" },
        "startMileage": { "type": "number" },
        "endMileage": { "type": "number" },
        "startTime": { "type": "string", "format": "date-time" },
        "endTime": { "type": "string", "format": "date-time" },
        "status": { "type": "string", "enum": ["IN_PROGRESS", "COMPLETED"] },
        "stops": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": { "type": "string" },
              "status": { "type": "string", "enum": ["PENDING", "COMPLETED"] },
              "arrivalTime": { "type": "string", "format": "date-time" },
              "departureTime": { "type": "string", "format": "date-time" },
              "collectedCars": { "type": "number" },
              "collectedItems": { "type": "number" },
              "mileageAtStop": { "type": "number" }
            },
            "required": ["name", "status"]
          }
        }
      },
      "required": ["driverId", "driverName", "vehicleId", "startMileage", "startTime", "status", "stops"]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/companies/{companyId}",
        "definition": {
          "entityName": "Company",
          "schema": { "$ref": "#/backend/entities/Company" },
          "description": "Stores company information."
        }
      },
      {
        "path": "/companies/{companyId}/sectors/{sectorId}",
        "definition": {
          "entityName": "Sector",
          "schema": { "$ref": "#/backend/entities/Sector" },
          "description": "Stores sector information within a company."
        }
      },
      {
        "path": "/companies/{companyId}/sectors/{sectorId}/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": { "$ref": "#/backend/entities/User" },
          "description": "Stores user information within a company and sector."
        }
      },
      {
        "path": "/companies/{companyId}/sectors/{sectorId}/vehicles/{vehicleId}",
        "definition": {
          "entityName": "Vehicle",
          "schema": { "$ref": "#/backend/entities/Vehicle" },
          "description": "Stores vehicle information within a company and sector."
        }
      },
       {
        "path": "/companies/{companyId}/sectors/{sectorId}/runs/{runId}",
        "definition": {
          "entityName": "Run",
          "schema": { "$ref": "#/backend/entities/Run" },
          "description": "Stores truck run data within a company and sector."
        }
      }
    ],
    "reasoning": "This Firestore structure prioritizes authorization independence and efficient data retrieval for the Frotacontrol application. It leverages path-based ownership for user data within companies and sectors, eliminating the need for `get()` calls in security rules. The structure enforces homogeneous security postures within collections and subcollections.\n\n*   `/companies/{companyId}`: Stores company information.\n*   `/companies/{companyId}/sectors/{sectorId}`: Stores sector information within each company.\n*   `/companies/{companyId}/sectors/{sectorId}/users/{userId}`: Stores user information, keyed by their unique identifier (`matricula`). This structure allows for direct access to user data based on company, sector, and ID, crucial for authentication and authorization. This design uses the appropriate Hierarchical Paths for User-Owned Data.\n\nThis design facilitates simple, robust security rules:\n\n*   Rules can directly verify `request.auth.uid` against the `userId` path segment, ensuring that users can only access their own data within a specific company and sector.\n*   `list` operations are secured because each subcollection contains only documents with the same security requirements (users belonging to a specific sector within a specific company).\n\nDenormalization Strategy:\n\nWhile the current design focuses on user authentication, future features might require denormalization for collaborative data access. If sectors or companies need shared data (e.g., shared vehicle logs), a membership map (`members: {uid1: 'role', uid2: 'role'}`) should be added to relevant documents and denormalized to child documents to maintain authorization independence. However, for the core login functionality, this is unnecessary."
  }
}